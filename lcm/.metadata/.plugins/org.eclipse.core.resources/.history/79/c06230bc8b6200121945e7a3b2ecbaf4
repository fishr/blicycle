#include "opencv/cv.h"
#include "opencv/highgui.h"
#include "opencv/cvaux.h"
#include <sys/types.h>
#include <netinet/in.h>
#include <netdb.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <math.h>
#include <getopt.h>
#include <lcm/lcm.h>
#include <lcmtypes/bot_core.h>

using namespace std;
using namespace cv;

bool gotOne = false;
bool gotTwo = false;

typedef struct _Comp {
	lcm_t* subscribe_lcm;
	lcm_t* publish_lcm;
	Mat iOne;
	Mat iTwo;
}Comp;

int msgHeight = 0;
int msgWidth = 0;


void on_image_frame1(const lcm_recv_buf_t *rbuf, const char *channel,const bot_core_image_t *msg, void *user_data) {
	Comp *self = (Comp*) user_data;

	self->iOne.data = msg->data;
	gotOne = true;

	msgHeight = msg->height;
	msgWidth = msg->width;
	
	printf("one!\n");

}

void on_image_frame2(const lcm_recv_buf_t *rbuf, const char *channel, const bot_core_image_t *msg, void *user_data) {
	Comp *self = (Comp*) user_data;

	self->iTwo.data = msg->data;
	gotTwo = true;

	printf("two!\n");

}

int main(int argc, char** argv) {


   char* lcmChannel1 = argv[1];
   char* lcmChannel2 = argv[2];


	Comp *self = (Comp*) calloc(1, sizeof(Comp));

	self->publish_lcm = lcm_create(NULL);
	self->subscribe_lcm = lcm_create(NULL);

	bot_core_image_t_subscription_t * sub1 = bot_core_image_t_subscribe(self->subscribe_lcm, lcmChannel1, on_image_frame1, self);
	bot_core_image_t_subscription_t * sub2 = bot_core_image_t_subscribe(self->subscribe_lcm, lcmChannel2, on_image_frame2, self);

	while(1){
	    lcm_handle(self->subscribe_lcm);

	if (gotOne&&gotTwo){
		printf("running stitch\n");
		IplImage* stitch = cvCreateImage(cvSize(msgWidth*2, msgHeight), IPL_DEPTH_8U, 3);
		
		cvSetImageROI(stitch, cvRect(0,0, msgWidth, msgHeight));
		IplImage* iOne = (IplImage*) &self->iOne;
		cvCopy(iOne, stitch, 0);

		cvSetImageROI(stitch, cvRect(msgWidth,0, msgWidth, msgHeight));
		IplImage* iTwo = (IplImage*) &self->iTwo;
		cvCopy(iTwo, stitch, 0);

		cvResetImageROI(stitch);

		cvNamedWindow("testing", CV_WINDOW_AUTOSIZE);
		cvShowImage("testing", stitch);

		cvWaitKey(33);

		cvReleaseImage(&iOne);
		cvReleaseImage(&iTwo);
		cvReleaseImage(&stitch);
	}

}
}

